<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    {% load static %}
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
</head>
<body>
<body>
    <div class="container">
            {% if messages %}
        <div class="messages">
            {% for message in messages %}
                <div class="alert {{ message.tags }}">{{ message }}</div>
            {% endfor %}
        </div>
            {% endif %}
        <div class="header">
            <h1>Ваши сделки, {{ request.bitrix_user.first_name }} {{ request.bitrix_user.last_name }}</h1>
            <button class="btn-add-deal" onclick="toggleDealForm()">Добавить сделку</button>
        </div>

        <div id="dealFormContainer" class="deal-form-container">
            <h2>Добавление новой сделки</h2>
            <form method="post" action="{% url 'create_deal' %}">
                {% csrf_token %}
                <table class="deal-form-table">
                    <tr>
                        <th>Название сделки</th>
                        <td><input type="text" name="title" required></td>
                    </tr>
                    <tr>
                        <th>Стадия сделки</th>
                        <td>
                            <select name="stage_id" required>
                                <option value="NEW">Новая</option>
                                <option value="PREPARATION">Подготовка документов</option>
                                <option value="PREPAYMENT_INVOICE">Счёт на предоплату</option>
                                <option value="EXECUTING">В работе</option>
                                <option value="FINAL_INVOICE">Финальный счёт</option>
                            </select>
                        </td>
                    </tr>
                    <tr>
                        <th>Сумма</th>
                        <td><input type="number" step="0.01" name="opportunity" required></td>
                    </tr>
                    <tr>
                        <th>Валюта</th>
                        <td>
                            <select name="currency">
                                <option value="RUB">RUB</option>
                                <option value="USD">USD</option>
                                <option value="EUR">EUR</option>
                                <option value="BYN">BYN</option>
                                <option value="UAH">UAH</option>
                            </select>
                        </td>
                    </tr>
              <tr>
                    <th>Дата начала</th>
                    <td>
                        <input type="date" name="begindate" id="begindate" required>
                    </td>
                </tr>
                <tr>
                    <th>Дата завершения</th>
                    <td>
                        <input type="date" name="closedate" id="closedate" required>
                        <div class="date-error" id="dateError">Дата завершения не может быть раньше даты начала</div>
                    </td>
                </tr>
                    <tr>
                        <th>Приоритет</th>
                        <td>
                            <select name="priorities" required>
                                <option value="50">Высокий</option>
                                <option value="52" selected>Средний</option>
                                <option value="54">Низкий</option>
                            </select>
                        </td>
                    </tr>
                </table>
                <div class="deal-form-buttons">
                    <button type="submit" class="btn-create">Создать</button>
                    <button type="button" class="btn-cancel" onclick="toggleDealForm()">Отмена</button>
                </div>
            </form>
        </div>

        {% if deals %}
            <h2>Последние {{ deals_count }} активных сделок</h2>
            <table class="deals-table">
                <thead>
                    <tr>
                        <th>Название</th>
                        <th>Стадия</th>
                        <th>Приоритет</th>
                        <th>Сумма</th>
                        <th>Дата начала</th>
                        <th>Дата завершения</th>
                    </tr>
                </thead>
                <tbody>
                        {% for deal in deals %}
                            <tr>
                                <td>{{ deal.TITLE }}</td>
                                <td>{{ deal.stage_name }}</td>
                                <td class="{{ deal.priority_class }}">{{ deal.priority_name }}</td>
                                <td>{{ deal.OPPORTUNITY|default:"0" }} {{ deal.CURRENCY_ID}}</td>
                                <td>{{ deal.formatted_begin }}</td>
                                <td>{{ deal.formatted_close }}</td>
                            </tr>
                        {% endfor %}
                </tbody>
            </table>
        {% else %}
            <div class="no-deals">
                У вас пока нет ни одной активной сделки
            </div>
        {% endif %}
    </div>
    <script src="//api.bitrix24.com/api/v1/"></script>
    <script src="{% static 'js/deals_table.js' %}" defer></script>
</body>
</html>