<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö–æ–º–ø–∞–Ω–∏–∏ –Ω–∞ –∫–∞—Ä—Ç–µ - Bitrix24</title>
    <script src="https://api-maps.yandex.ru/2.1/?apikey={{ yandex_api_key }}&lang=ru_RU" type="text/javascript"></script>
    {% load static %}
    <link rel="stylesheet" href="{% static 'css/map.css' %}">
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <h2>üó∫Ô∏è –ö–æ–º–ø–∞–Ω–∏–∏ –Ω–∞ –∫–∞—Ä—Ç–µ</h2>

            {% if error %}
            <div class="error">
                <strong>–û—à–∏–±–∫–∞:</strong> {{ error }}
            </div>
            {% endif %}

            <div class="stats">
                –í—Å–µ–≥–æ –∫–æ–º–ø–∞–Ω–∏–π: <strong>{{ points|length }}</strong><br>
                –° –∞–¥—Ä–µ—Å–∞–º–∏: <strong>{{ points_with_coords|length }}</strong><br>
                –ë–µ–∑ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç: <strong>{{ points_without_coords }}</strong>
            </div>

            {% if points %}
            <div class="company-list">
                {% for point in points %}
                <div class="company-item" data-company-id="{{ point.id }}" onclick="focusOnCompany('{{ point.id }}')">
                    <div class="company-title">{{ point.title }}</div>

                    <div class="company-address {% if not point.has_address %}no-address{% endif %}">
                        üìç {{ point.address|default:"–ê–¥—Ä–µ—Å –Ω–µ —É–∫–∞–∑–∞–Ω" }}
                    </div>

                    {% if point.geocode %}
                    <div class="company-contacts">
                        {% if point.phone %}
                        <div class="contact-item">üìû {{ point.phone }}</div>
                        {% endif %}
                        {% if point.email %}
                        <div class="contact-item">‚úâÔ∏è {{ point.email }}</div>
                        {% endif %}
                        <div class="contact-item">–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: {{ point.geocode.latitude|floatformat:4 }}, {{ point.geocode.longitude|floatformat:4 }}</div>
                    </div>
                    {% else %}
                    <div class="company-contacts no-address">
                        ‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="empty-state">
                <h3>ü§î –ö–æ–º–ø–∞–Ω–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</h3>
                <p>–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞–ª–∏—á–∏–µ –∫–æ–º–ø–∞–Ω–∏–π –≤ Bitrix24 CRM</p>
            </div>
            {% endif %}
        </div>

        <div class="map-container">
            <div id="map"></div>
        </div>
    </div>

    <script type="text/javascript">
        ymaps.ready(init);

        let map;
        let placemarks = {};
        let companyItems = {};

        function init() {
            map = new ymaps.Map('map', {
                center: [55.7558, 37.6173],
                zoom: 10
            });

            document.querySelectorAll('.company-item').forEach(item => {
                const companyId = item.getAttribute('data-company-id');
                companyItems[companyId] = item;
            });

            {% for point in points_with_coords %}
            {% if point.geocode %}
            (function() {
                const companyId = '{{ point.id }}';
                const coordinates = [{{ point.geocode.latitude }}, {{ point.geocode.longitude }}];

                const placemark = new ymaps.Placemark(coordinates, {
                    balloonContentHeader: '<div class="balloon-title">{{ point.title|escapejs }}</div>',
                    balloonContentBody: `
                        <div class="balloon-content">
                            <div class="balloon-address">üìç {{ point.address|escapejs }}</div>
                            {% if point.phone %}
                            <div class="balloon-contacts">üìû {{ point.phone|escapejs }}</div>
                            {% endif %}
                            {% if point.email %}
                            <div class="balloon-contacts">‚úâÔ∏è {{ point.email|escapejs }}</div>
                            {% endif %}
                        </div>
                    `,
                    balloonContentFooter: 'ID: {{ point.id }}'
                }, {
                    preset: 'islands#blueCompanyIcon'
                });

                placemark.events.add('click', function() {
                    focusOnCompany(companyId);
                });

                map.geoObjects.add(placemark);
                placemarks[companyId] = placemark;
            })();
            {% endif %}
            {% endfor %}

            if (map.geoObjects.getLength() > 0) {
                map.setBounds(map.geoObjects.getBounds(), {
                    checkZoomRange: true
                });
            }
        }

        function focusOnCompany(companyId) {
            document.querySelectorAll('.company-item').forEach(item => {
                item.classList.remove('selected');
            });

            if (companyItems[companyId]) {
                companyItems[companyId].classList.add('selected');
                companyItems[companyId].scrollIntoView({behavior: 'smooth', block: 'center'});
            }

            if (placemarks[companyId]) {
                map.setCenter(placemarks[companyId].geometry.getCoordinates(), 15);
                placemarks[companyId].balloon.open();
            }
        }
    </script>
</body>
</html>